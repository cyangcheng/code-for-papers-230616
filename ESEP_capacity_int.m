

clear
clc


%%系统参数
%所有参数均用有名值表示
paragen=xlsread('excel2017','机组参数');
loadcurve=xlsread('excel2017','负荷曲线');
netpara=xlsread('excel2017','网络参数');
%% 规模变量
%机组数
gennum=size(paragen);
gennum=gennum(1,1);
%节点数
numnodes=size(loadcurve);
numnodes=numnodes(1,1)-1;
%时间范围
T=96*12; %典型日数量
%% 储能参数
% bus   eff_c  eff_dc   E_init E_lower
data_s = [
	6	0.95  0.95  0.5   0.2
];
%% 新能源参数
% bus   capacity
data_r = [
 	6	1.5;
];
branch_num=size(netpara);%网络中的支路
branch_num=branch_num(1,1);
PL_max=netpara(:,6);%线路最大负荷
PL_min=netpara(:,7);%线路最小负荷
limit=paragen(:,3:4);%机组出力上下限//limit(:,1)表示上限，limit(:,2)表示下限
Pmin=limit(:,2);             
Pmin = 2*Pmin;
Pmax=limit(:,1);
Ru = [0.3;0.3;0.2;0.2;0.15;0.15];
Rd = [0.3;0.3;0.2;0.2;0.15;0.15];
% Su=(limit(:,1)+limit(:,2))/2;
% Sd=(limit(:,1)+limit(:,2))/2;
c = 3;
eff_c  = data_s(:,2);
eff_dc = data_s(:,3);
E_lower = data_s(:,5);
N_r = length(data_r(:,1));
N_s = length(data_s(:,1));
 beta = 0;% 新能源渗透率
% beta = sdpvar(1);
H = 2; %持续充放电时间
P_c = sdpvar(N_s,T,'full'); % 储能充电
P_dc = sdpvar(N_s,T,'full'); % 储能放电
E_init = sdpvar(N_s,1,'full'); %储能初始状态
P_s = sdpvar(N_s,1,'full'); % 
E_s = sdpvar(N_s,T,'full');% 
P_r = sdpvar(N_r,T,'full');% 新能源变量

para=paragen(:,5:7);%成本系数//para(:,1)表示系数a,para(:,2)表示系数b,para(:,3)表示系数c。
price=100;
para=price*para;%价格换算
lasttime=paragen(:,9);%持续时间
lasttime=3*lasttime;
Rud=paragen(:,8);%上下爬坡速率//因题中简化上坡下坡速度相同
H_start=paragen(:,10);%启动成本
J_stop =paragen(:,11);%关停成本
power_gen=paragen(:,2);%发电机对应节点
BaseMVA=100;%参考电压
slack_bus=26;%参考节点



%% 直流潮流下的导纳矩阵节点参数初始化
netpara(:,4)=1./netpara(:,4);  %电抗求倒数成电纳，这个地方只能计算一次，之前这个值多次计算出了问题
Y=zeros(numnodes,numnodes);
YY=zeros(numnodes,numnodes);
% 直流潮流的导纳矩阵计算
for k=1:branch_num
    i=netpara(k,2);%首节点
    j=netpara(k,3);%尾节点
    Y(i,j)=-netpara(k,4);%导纳矩阵中非对角元素
    Y(j,i)= Y(i,j);
end
for k=1:numnodes
    Y(k,k)=-sum(Y(k,:)); %导纳矩阵中的对角元素
end
%再删除掉平衡节点所在的行与列
YY=Y;
Y(slack_bus,:)=[];
Y(:,slack_bus)=[];

%% 各时刻节点负荷
pd=[1.41110534465526,1.25642544747731,1.09190823764592,1.06128067413041,1.09445752625110,1.63786812047008,1.51283932176602,2.13632501419419,1.10832844629935,1.67662962851302,1.23477541849268,1.40322480451401,1.38079907758005,1.23051332859958,1.07264155053211,1.04985318628551,1.09117399683633,1.60868574776845,1.49375942723746,2.08669662764290,1.09757545832997,1.66193980507171,1.22545958648456,1.38476980017021,1.34232206692715,1.20934541819950,1.05581445259645,1.02683750424187,1.07800401181645,1.59091723863789,1.46519158082322,2.04466358623839,1.08773278926711,1.65707926002745,1.18972692393253,1.35511229685305,1.32700479184076,1.17698164560788,1.03785286242403,1.01268581427686,1.05910764758870,1.55945307106072,1.45411601604114,2.00679749221722,1.06642233920537,1.61975712096162,1.19066565739972,1.32908861493088,1.30317533099416,1.16282541394001,1.02562370702354,1.00863881430828,1.05272598327360,1.53799053310049,1.42645452828682,1.97893547121717,1.04028441627255,1.59352731541851,1.16878866001650,1.31339729031988,1.28602425900974,1.14959790076341,1.01816682550141,0.997438527635279,1.02854867540119,1.52527436729865,1.40755245848970,1.93321131303424,1.04017285358586,1.58096731522165,1.15245625757861,1.29084777258820,1.27070383933729,1.13017469983866,1.00871311180189,0.988149828861423,1.03109505255136,1.48956033877415,1.38697275501455,1.91760523210523,1.01696362555000,1.56139645147613,1.14870551589502,1.27381198897504,1.26545026158095,1.11946142273226,0.991672204791117,0.988609588210871,1.01591158264236,1.48061378038349,1.36906962492680,1.88677794993129,1.02559971765984,1.54565377006287,1.13425046388560,1.25915919938449,1.23847142684940,1.10322509449358,0.975162326900990,0.973500124590358,1.00893518909918,1.45727773454300,1.34633040410885,1.86633869032334,1.00071343942943,1.52972499641151,1.12452960537791,1.24382305797427,1.22728732674529,1.10269977177704,0.986396618032868,0.971993504401215,1.00664710624401,1.44519170109517,1.34046754104188,1.82810367089067,0.998511998088558,1.51016263389995,1.10719768058190,1.23182739232154,1.21752221602950,1.08397249827345,0.977337566100810,0.964096777094830,0.995983554738022,1.43484012925421,1.31952217360493,1.80113717958356,0.995471624237510,1.49029958719095,1.10518629172573,1.22584493123826,1.21192347076379,1.08084653086497,0.969373761327630,0.958742584032661,0.983799117569233,1.41785046146655,1.30277938861580,1.78747855498771,0.987143319369038,1.47382650799331,1.09564605289858,1.21702472629811,1.20764891939013,1.07212577700639,0.966000795568711,0.947383221611411,0.984253752924819,1.39877860190986,1.30372697271540,1.76675654498196,0.978021964565596,1.44970777623448,1.09918834251272,1.21904939014891,1.19916153972740,1.06601905993654,0.965329905706604,0.948292667021810,0.977698456182694,1.39826096512448,1.28630677568025,1.74790874284585,0.971420261031345,1.44853345758282,1.10099453979514,1.21371429642238,1.20929452765934,1.06545612262847,0.956729215530192,0.939869335910982,0.981107871951142,1.37128236292774,1.28350478255902,1.72904556717792,0.971478662564947,1.42400061591869,1.09198218574108,1.20235726197264,1.20547437910646,1.05536540701983,0.960440130083394,0.942567859868463,0.986534732139818,1.37381627919359,1.27159238106123,1.71921617430219,0.975469065947006,1.41276539273961,1.09268579921266,1.20371837404429,1.19091312165451,1.06164168071820,0.948912783088156,0.943921110474974,0.973908469540470,1.36202324317730,1.26795553075134,1.69742372192330,0.964826592588213,1.40239903168507,1.09124526660753,1.19979644441109,1.19572883231891,1.05693427164853,0.950851504698563,0.936430166181394,0.970505924519637,1.34576746715853,1.25232685817167,1.68245778784723,0.967436437191775,1.39601562097396,1.08291020737810,1.19607737814162,1.18251436231763,1.05627176639524,0.949133346404985,0.948163694513905,0.980492646866858,1.35109010059699,1.25098391362696,1.66742221377080,0.953872954986444,1.37805449551340,1.08054456641436,1.19924317375373,1.19736733694796,1.05621773186528,0.954591882007780,0.952353524991521,0.989083205561448,1.34305421170379,1.24728615947048,1.66204973798754,0.974395595493727,1.37385249619132,1.09193222712887,1.19431159111533,1.19777818540355,1.05924354915679,0.956837342783452,0.955176887345824,1.00081813124926,1.34226023055636,1.24643756007110,1.64520924783585,0.968646857170003,1.37794735897765,1.09601288215788,1.21153661155265,1.20810215834440,1.06366681106959,0.957857710396216,0.973236647988912,1.00611386458450,1.35234442433885,1.24747889027915,1.64685532117467,0.995223927090173,1.37647829470972,1.10345800195033,1.21864622726674,1.20899291213019,1.08613364657959,0.978593519494286,0.970625522535946,1.02519178018225,1.37072315130424,1.26228842740793,1.64580211380428,1.00649676450303,1.37813228734926,1.13504036959227,1.22598712090522,1.23790080313317,1.08881371275901,0.988330215768664,0.986899115848459,1.07417151960063,1.37112142380059,1.27254345914533,1.63260534387535,1.02449154395078,1.37821310571504,1.15217071294719,1.25634334718889,1.27183646867215,1.11421634680613,1.01375823665404,1.04012813535416,1.09806666020098,1.38713218087674,1.28602076502524,1.64042358138372,1.03927650930561,1.38314352448693,1.17193710304673,1.27373233447577,1.32681578755140,1.14156340874852,1.06023736523005,1.08681932613228,1.14243331799516,1.40929029721742,1.29623177732784,1.62859165004574,1.09566352103237,1.39033570675153,1.23059391443056,1.33813113029936,1.36438550702018,1.16276567324443,1.08406065376819,1.14087540003183,1.16517195664135,1.42186054564050,1.30350326469327,1.64182452010875,1.12896707469029,1.41397418258924,1.26991311844708,1.37785116827254,1.44099470902256,1.20414936836138,1.14550525099292,1.19463323564233,1.17980390181200,1.44423433503144,1.33844043140193,1.64213055976163,1.16773219179266,1.41436418638643,1.32182201795128,1.44196465104553,1.47867505901158,1.23007324992278,1.18090811598995,1.20170756688288,1.19355196310973,1.45485095481289,1.36805589600384,1.65057834649825,1.18632927001301,1.42328896759449,1.35505488460598,1.47158686988915,1.53713587825629,1.28847188339825,1.22107091060615,1.22790418315067,1.21535827337050,1.47748827887936,1.38770851063933,1.68478290336067,1.21403524215248,1.44314071788192,1.41085869677652,1.52432631812944,1.58422638948762,1.33494390809559,1.26238450124939,1.25470670641574,1.22646830815806,1.51339236108107,1.42464029650953,1.72743454697032,1.24384238936771,1.45725292963800,1.44001207179174,1.57132809050179,1.63985575285509,1.41438398404197,1.29526765702240,1.27648180692824,1.25716597662427,1.56261874980918,1.47558880222759,1.79220564413378,1.29161275724171,1.50399803844018,1.46571841763946,1.61287505426764,1.70349445560347,1.47734329402479,1.34553339523902,1.30620720325349,1.29788460490838,1.62258030813970,1.55553510167412,1.84732761894209,1.35366209771647,1.54519529251682,1.52269806172661,1.67255910436960,1.78030954749950,1.53857536290457,1.38254704767034,1.34236783335420,1.33110268234950,1.72130081186037,1.62091280701673,1.94509657950904,1.42209450069636,1.57430476496089,1.57152664422047,1.73634348957696,1.84841424931509,1.60200211912200,1.42925058282688,1.38408202422682,1.37028074370192,1.78649999367465,1.70109609043402,2.01883251945373,1.48336523355550,1.61630904240629,1.63452648084607,1.82463637780554,1.91306563279108,1.66208758511387,1.47556364792413,1.40730767208187,1.41803701996676,1.83304235716923,1.76572243647021,2.09871278974807,1.52580842461871,1.66971344121202,1.66632312310972,1.89725005231276,1.98251735506914,1.70923690499358,1.51657725435932,1.43955231232304,1.43883798567488,1.90514666239775,1.82700050431183,2.19243801060365,1.56767726663886,1.71894087813549,1.71335575702437,1.95707664148013,2.03464786739725,1.74756427294090,1.54521345885126,1.47075282836104,1.48901580069307,1.96579646293376,1.90274725022544,2.24825754331948,1.64841859542817,1.78263407988720,1.76114848282174,2.02426834606523,2.06855010874113,1.77786949182077,1.56400315113589,1.48265090571486,1.49359907004357,1.99578166741523,1.93815011498397,2.31614401181698,1.68439418029363,1.83560596991839,1.76353578529690,2.04751716869668,2.09354061348325,1.78887460213444,1.58357459800716,1.50290931286897,1.52233228090116,2.04630837884706,1.97759229413765,2.37330206376131,1.71553320816680,1.88065574497020,1.79441337488526,2.07479948162079,2.10564830725003,1.79947119291804,1.59754054417851,1.50928154402215,1.52907506878694,2.09163496452302,2.01275642912565,2.42690291989502,1.74996880922632,1.91815291357987,1.80868163419018,2.10429977352260,2.12081477576433,1.80793900865252,1.61465341963814,1.51727399660629,1.53876483345602,2.12647093327710,2.04498802595300,2.47703974320082,1.78205460553855,1.96445398465114,1.83286721076175,2.12690623723925,2.14752972642190,1.83299309675768,1.63172343952949,1.54978519924539,1.56500744868566,2.15804200485521,2.09153830755581,2.53010537814797,1.80467760546104,2.00096385937146,1.85590408686225,2.14709232606906,2.15990968982546,1.84707817587574,1.64280599228058,1.56591077962318,1.56812328389683,2.16530359339287,2.11381707130064,2.58112468773288,1.82442023968567,2.02026909205076,1.86132978330366,2.16348295557982,2.18726862952644,1.84673044452109,1.64966896011592,1.56996069164301,1.59044746347778,2.20113221268422,2.14323514605038,2.62083494374195,1.86079654164416,2.05681529943996,1.86730572268003,2.18500430338092,2.21063833090435,1.86860453092630,1.66919056344989,1.59029840270545,1.62409525450584,2.23459099942292,2.18671710466884,2.67960052310186,1.88703065444734,2.08665027928260,1.88189784095879,2.20051873459219,2.18649677376757,1.85675489832349,1.64457643835037,1.56819711548609,1.60819734120429,2.23468625879633,2.19505286209893,2.69821192439295,1.88910213411303,2.09111790967090,1.87163978030650,2.20319251279198,2.15975201095553,1.81438414125574,1.60805526720848,1.53459439208818,1.55800811290089,2.23462104411219,2.17552496959285,2.71601397338978,1.84738933964172,2.10058163858483,1.83769188820673,2.14614252990759,2.06035153372853,1.73645842974225,1.52927059359072,1.44815975745666,1.50440329771306,2.18791145470332,2.15182593692203,2.69778849878563,1.81726695274275,2.09554734353441,1.75274518178200,2.07094626065623,2.03210614750184,1.70996439072672,1.49813133318275,1.42101905107377,1.50052829956591,2.19079042280738,2.15961389720632,2.73356075521776,1.81925947551358,2.09725036285821,1.73628514599818,2.05869742541784,2.04220408349505,1.70894285936670,1.50388589346249,1.42670443880776,1.51506754777745,2.21885320958797,2.19335636448205,2.77703432946589,1.83843474747168,2.12731778449174,1.75735325603750,2.06510377717805,2.06164137567123,1.68973137160335,1.50361269368649,1.45060051073981,1.52073127519249,2.25071937498832,2.21604131763898,2.80287401434816,1.86933353111689,2.15385386222253,1.76861118773087,2.07414780700397,2.06851051462254,1.70204507212743,1.53226450305256,1.46034803705441,1.52954507528937,2.27739240260180,2.22663185297775,2.83400000000000,1.87383481704260,2.18043628950611,1.78151379516927,2.08593222611513,2.07187160250363,1.70840915144509,1.53518830625197,1.47900380837124,1.55494922367469,2.29042101289977,2.25670789151642,2.82964323266675,1.89210710626915,2.20786626680122,1.82081203766374,2.09539991408318,2.06443626515229,1.70096112007838,1.54324096507829,1.47532107477066,1.55393502729715,2.28347664476540,2.25172483640460,2.82442983215474,1.89131475525033,2.22427785783404,1.81853268857735,2.10331713629177,2.03997236469161,1.67937735397324,1.53108657355276,1.48871930927703,1.55097419143947,2.28232864309121,2.26826965080080,2.82247014926078,1.88655855155421,2.22629786383383,1.80710566592131,2.09013131457845,2.03753894758342,1.68091174859647,1.53370643348999,1.49103778741240,1.56718163957088,2.28230814783126,2.27556431175014,2.82091106659620,1.90180723602810,2.23435902389412,1.81348628263730,2.07998213864663,2.03363378788336,1.66767387009150,1.52741828095980,1.48882586507200,1.57633769751085,2.28445462295272,2.28345801216886,2.82074174309873,1.92939547293392,2.23771242500930,1.82370090459557,2.09418786278386,2.02703179326323,1.65356026074162,1.52033195569327,1.50187042964256,1.58365693083038,2.29369615830197,2.28194993571559,2.80792344801062,1.94029985155512,2.24505692949593,1.79647029667968,2.08597228530333,2.00621475761136,1.63664919925788,1.51499569571525,1.47408829567658,1.59275837171089,2.28847064570784,2.29932459885849,2.79368837678853,1.95638607034913,2.24291930500689,1.80901946671706,2.09614847820201,2.00451756119757,1.61300338724521,1.50415455225112,1.47607627746004,1.59644459810348,2.27965230343111,2.28643992641223,2.79298103691690,1.95015789152632,2.22815716443376,1.79996658745121,2.08117322723142,1.99466161642458,1.62314394388693,1.51435531752000,1.46834968966942,1.60263644306492,2.28672919732445,2.30144452327519,2.79502549961572,1.97958668076438,2.23109599057403,1.79671193850145,2.08810385434756,1.98284412490174,1.61022608216533,1.50422302719247,1.48802175136952,1.58523813888352,2.27591157684269,2.30830947063758,2.79269665758297,1.98701433254229,2.22607473893744,1.80137323103012,2.08438176035568,1.97106762509129,1.61688129625113,1.50794046333333,1.48568883461150,1.61157962314223,2.28432000199553,2.30400743722744,2.78722962122321,1.99608235161267,2.21932088835738,1.81299461462344,2.09629986789984,1.97561281358816,1.59642188958919,1.52752891148005,1.50247342697357,1.60617419061845,2.26830016175217,2.30583995220283,2.76829890313813,1.99427079696684,2.21618222657578,1.80200813690630,2.08811503390548,1.97430666916692,1.62132656752358,1.53396251512690,1.51857536750536,1.61863881577074,2.27012545741623,2.32079307659238,2.77865676295871,1.99475361434829,2.19342483942339,1.81625788167081,2.11381916649886,1.99345492296566,1.63856870610000,1.54805842321194,1.52587154291214,1.62518444633915,2.28967640783505,2.32345823669456,2.74865339095031,1.99964304021530,2.17347515143860,1.83208953328536,2.11757084011040,1.96975123125134,1.63082989055610,1.55254864644338,1.54212662013401,1.62672652653580,2.28607169979763,2.33796674141994,2.77199817175206,2.02031683800486,2.17731579525144,1.85469855846233,2.14698868232533,1.97910758990224,1.65364061403779,1.56031878859919,1.54818221400965,1.63422521590786,2.29417944075302,2.33164260561931,2.76117076930617,1.99698440182003,2.16092423440897,1.82786237846735,2.13070006642969,1.97882810095413,1.64528133243286,1.54178249962751,1.54406010052917,1.63813491659530,2.28311587118941,2.31983932137680,2.74277038202184,1.99471588289311,2.15505915928014,1.82746864934333,2.13360698402480,1.96540937118781,1.63529472694928,1.50349239687328,1.54911128118388,1.61385163605365,2.26798410640788,2.29942940766122,2.70642121389386,1.96930428266166,2.12360244474158,1.80451363861149,2.10699823976375,1.94426277170822,1.62932088277113,1.51702094269179,1.51725466521285,1.59122234695905,2.25246851013761,2.27042963440569,2.67492630283052,1.94318033411663,2.09399618017054,1.79754819209142,2.08729333699429,1.94998647163815,1.63252173032197,1.50347725826124,1.50715626415003,1.57923681266890,2.23986029772456,2.24461067851066,2.63705228950864,1.90584771428977,2.07564866295342,1.78851336229637,2.08150209226223,1.97855350358433,1.63461813056381,1.49027967267177,1.49933802664167,1.54361501460290,2.23127276711012,2.22232818943901,2.61112037416786,1.89418207872685,2.04285016892915,1.80118189781525,2.10498195909078,2.01058806115044,1.66313473703945,1.49436591855297,1.49033417406007,1.55995300777374,2.22628784933490,2.24030934389742,2.60917489736175,1.87969267286011,2.04090865236964,1.79198810961259,2.09689471339533,2.03779491235669,1.68486092653885,1.50391582248060,1.49344360442798,1.53869041993351,2.22620050806972,2.21467997422501,2.56716514640479,1.87237844679004,2.02862697606189,1.78342515017587,2.10287880460722,2.05217508410450,1.69067627618652,1.51071415875755,1.47243884521690,1.52970717947551,2.20727211891015,2.19806272583336,2.55091845474573,1.86458536358513,2.06283525944362,1.75964739433748,2.08640665793377,2.05095325203354,1.69057880475125,1.51649620226625,1.48821902435804,1.50130120352013,2.20020989975171,2.16761636428939,2.51766253017827,1.89790312452338,2.07008496962645,1.74752875354758,2.08823265239473,2.06707790107963,1.69277407402216,1.51951351784680,1.49954834185152,1.49669056780432,2.17648804170295,2.14995475915976,2.50181178089757,1.88798184939510,2.06120863316939,1.74153243458242,2.10221525163557,2.07046111434928,1.70035835647467,1.51473285983662,1.49267803784121,1.49806751609241,2.18193481653005,2.13860913799525,2.48975812106451,1.86231870851411,2.06713146994374,1.72791258963711,2.08109753297875,2.07235628254848,1.70428214757879,1.49852017192094,1.47458345767495,1.51359790157626,2.20466844697279,2.14842152959553,2.50393333425038,1.84512466409776,2.05321431792184,1.71845852582365,2.08479121240996,2.08029120721440,1.71822340570879,1.51061715239189,1.45061180716138,1.53606601900891,2.24534573414606,2.17466414363269,2.54970058172888,1.82950973372881,2.07439142835280,1.71555510221304,2.08074607510479,2.08302577358963,1.73202678262439,1.51484244335401,1.44462806534794,1.52915705221172,2.29152569274357,2.23421741616041,2.59287789709578,1.82201430580645,2.08121911052211,1.70897872696597,2.07258173756287,2.08452919099940,1.72650314967810,1.49947846931638,1.43855395454692,1.51421615438296,2.30323814292889,2.24669054254667,2.62904306818386,1.80173295760324,2.07698159180672,1.70568949114709,2.06467289853211,2.05988851400262,1.71538205219626,1.48590590406307,1.40460373352165,1.50556876692479,2.34249236598856,2.27459145767592,2.66318380795594,1.78942472939824,2.08229141675113,1.66639788722317,2.02019200020428,2.03004654738347,1.70693601245189,1.46788119643195,1.37584956114201,1.48997933906526,2.34165017262494,2.30042205939097,2.67632677529346,1.77220192221526,2.05558741192419,1.64206057155532,1.99774228283337,1.99245272180659,1.69250390196857,1.42670210988225,1.36076088446357,1.45937040826554,2.33287189072888,2.29765255674816,2.66857910911715,1.75924015553755,2.04820727356558,1.61536110890823,1.96181001860581,1.93890182368885,1.66433619071410,1.39552383609645,1.33002059415636,1.43315550879966,2.32144428613959,2.27679336551739,2.65176528653387,1.72242610502025,2.02575219954675,1.58209319031479,1.90264488721187,1.87384925685774,1.61541723923266,1.34924151448537,1.27556438438155,1.39667707755490,2.28999781982726,2.24929048796472,2.62919492414378,1.68614611063053,2.00579156453884,1.52450938383763,1.85286208324034,1.81010854168673,1.56169259349372,1.31102547704769,1.24881030586748,1.36983950115861,2.23372458428004,2.20769694211127,2.59550113415387,1.64263527118931,1.96248312219926,1.47699428193999,1.78584913471837,1.74575854120508,1.51674809112175,1.27214798183658,1.21720848961072,1.33680809908134,2.18084038371999,2.17954099354046,2.56453678642608,1.61190790623979,1.94234617572487,1.44322712662291,1.73550583839319,1.69967896490160,1.47539316056015,1.25490642519342,1.19737071406882,1.31459990786104,2.15968446734588,2.12750061647265,2.52151808006834,1.57253490082435,1.92626484731668,1.40569502174567,1.67910380360630,1.65031294915932,1.43517726298419,1.22530109195408,1.17716960194038,1.30796402516869,2.10879442207024,2.12115016250206,2.47651430397838,1.56012291320447,1.90107241292750,1.38975483480908,1.65022223077328,1.62640348441499,1.41634296813902,1.21530528643964,1.17773382021711,1.31057433567661,2.10300876771339,2.09254633162489,2.45689557741511,1.56407092728034,1.89838384551412,1.39692093143853,1.63544402025641,1.57572072543432,1.38139427247399,1.19604092860908,1.15472500904033,1.28967636360282,2.04766343428140,2.04920411688425,2.40209454833690,1.54364354602721,1.87779412754004,1.36670060684220,1.60050301016479,1.52849035346153,1.34171382861939,1.15310432253976,1.13335039308605,1.25902341336831,2.01812075426589,1.99167224914260,2.35076570511461,1.51913935265103,1.83941994497033,1.33995421390156,1.55855835702833];
pd = 2*pd;
pd = pd(:,1:T);
%%
%优化变量
p          = sdpvar(gennum,T,'full');%24时刻优化的机组实时功率p(i,t)
u           = binvar(gennum,T,'full');%24时刻优化状态变量
costH       = sdpvar(gennum,T,'full');%24时刻优化启动成本
costJ       = sdpvar(gennum,T,'full');%24时刻优化关停成本


%约束条件
st1  = [];

%机组出力上下限约束
for     t = 1:T
    for   i = 1:gennum
         st1 = [st1,u(i,t)*Pmin(i)<=p(i,t)];
         st1 = [st1,p(i,t)<=u(i,t)*Pmax(i)];
    end
end
%爬坡约束
% for t=2:T
%     for i=1:gennum
%         st1=st1+[(p(i,t)-p(i,t-1))<=Rud(i,1)*u(i,t-1)+(u(i,t)-u(i,t-1))*Su(i)+(1-u(i,t))*Pmax(i)];%上坡
%         st1=st1+[(p(i,t-1)-p(i,t))<=Rud(i,1)*u(i,t)+(u(i,t-1)-u(i,t))*Sd(i)+(1-u(i,t-1))*Pmax(i)];%下坡
%     end
% end
for t=2:T
    for i=1:gennum
        st1=st1+[-Ru(i)*Pmax(i)<=p(i,t)-p(i,t-1)];%上坡
        st1=st1+[p(i,t)-p(i,t-1)<=Rd(i)*Pmax(i)];%下坡
    end
end
%启动约束
for t=2:T
    for i=1:gennum
        indicator=u(i,t)-u(i,t-1);%启停时间约束的简化表达式（自己推导的）,indicator为1表示启动，为0表示停止
        range=t:min(T,t+lasttime(i)-1);
        st1=st1+[u(i,range)>=indicator];
    end
end
%停机约束
for t=2:T
    for i=1:gennum
        indicator=u(i,t-1)-u(i,t);%启停时间约束
        range=t:min(T,t+lasttime(i)-1);%特别限制时间上限
        st1=st1+[u(i,range)<=1-indicator];
    end
end
% %启停成本约束
% for t=1:T   %启停成本零限约束
%     for i=1:gennum
%         st1=st1+[costH(i,t)>=0];
%         st1=st1+[costJ(i,t)>=0];
%     end
% end
% for i=1:gennum  %启停成本条件约束
%     for t=2:T
%         st1=st1+[costH(i,t)>=H_start(i,1)*(u(i,t)-u(i,t-1))];
%         st1=st1+[costJ(i,t)>=J_stop(i,1)*(u(i,t-1)-u(i,t))];
%     end
% end
% 储能约束
%    C_sto = [C_sto; 0 <= P_s <= 0; 0<= E_s <= 0]; %建模时必须去掉这个约束；测试的时候才用。
bigM = 10^5;
for i = 1:N_s
    st1 = [st1; P_s(i)*H(i)*E_lower(i)<=E_init(i)<=P_s(i)*H(i);];
    E_s(i,1) = E_init(i);
    for t = 1:T
                st1 = [st1; 0<=P_c(i,t)<=P_s(i); 0<=P_dc(i,t)<=P_s(i)];
    end
    for t = 2:T
        E_s(i,t) = E_s(i,t-1)+ P_c(i,t-1)*eff_c(i)-P_dc(i,t-1)/eff_dc(i);
        st1 = [st1; P_s(i)*H(i)*E_lower(i)<=E_s(i,t)<=P_s(i)*H(i)];
    end
end

% 可再生能源发电约束
w_1 = w_ref(data_r);
w_0 = w_1(1:T);
% w_0 = 0.5*w_0;
for t = 1:T
    P_r_max(:,t) = 5*(data_r(:,2))*w_0(t);
    st1 = [st1; 0<=P_r(:,t)<=P_r_max(:,t)]; %新能源出力小于预测的波动出力
    cur(:,t) =  P_r_max(:,t)-P_r(:,t);
    %    C_r = [C_r; 0<=P_r(:,t)<=0];%测试的时候才用。
end
     st1 = [st1; sum(P_r(:,t))>=beta*sum(pd(:,t))]; %新能源渗透约束
     % st1 = [st1; 0<=beta<=0.5]; %新能源出力小于预测的波动出力
    beta_true = sum(P_r(:,t))/sum(sum(pd(:,t)));
    

%负荷平衡约束
        st1=[st1,sum(p)+P_r+P_dc-P_c==pd];

%目标函数
% obj_1 = 0;
% obj_2 = 0;
%     for  t = 1:T
%         for  i = 1:gennum
%             obj_2=obj_2+costH(i,t)+costJ(i,t);%加上机组启停产生的开停机成本
%             obj_1=obj_1+para(i,2)*(BaseMVA*p(i,t));%煤耗成本
%         end
%     end
% obj_3 = 10000*sum(cur);
% obj_4 = 12000000*P_s;
% obj_5 = 300*sum(P_dc+P_c);% 因为用标幺值计算 这里都乘了100
%      obj=obj_1+obj_2+obj_3+obj_4+obj_5;   

obj = 12000000*P_s;

%% 求解
ops1 = sdpsettings('solver', 'cplex','savesolveroutput',1);
% ops1.cplex= cplexoptimset('cplex');
% ops1.cplex.mip.tolerances.absmipgap = 0.01;
result1 = solvesdp(st1,obj,ops1);
solve1=double(obj) ;
p1_double=double(p);
u_double = double(u);
value(P_s)
% value(obj)
P_C = P_dc-P_c;

%% 参数规划
% plp = Opt (st1, totalcost1, beta, P_s); % 利用MPT3工具包建模
% solution = plp.solve; % 利用MPT3工具包求解多参数规划，结果存在solution里面
% 
% for i = 1:N_s
%     figure;
%     solution.xopt.fplot('primal', 'position', i);
%     xlabel('beta');
%     ylabel(sprintf('x_%d(beta)', i));
% end


%% 绘制出力曲线
p_P_r = sum(p) + P_r;
subplot(1,2,1)
bar(value(pd)','stack')%阶梯图
% legend('Unit 1','Unit 2','Unit 3','Unit 4','Unit 5','Unit 6');	%在坐标轴上添加图例
subplot(1,2,2)
bar(value(p)','stack')%阶梯图
% legend('Unit 1','Unit 2','Unit 3','Unit 4','Unit 5','Unit 6');	%在坐标轴上添加图例
% stairs(value(p)')
% legend('Unit 1','Unit 2','Unit 3','Unit 4','Unit 5','Unit 6');	%在坐标轴上添加图例
cur_double = double(cur);

save('ESEP_cap_result','u_double')


